name: Deploy Development

on:
  push:
    branches: [ develop ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚀 Deploy to DEV Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "🔧 Starting DEV deployment..."
          
          cd /home/deploy/apps/utassets-dev
          
          # Pull latest changes
          echo "📥 Pulling latest code..."
          git pull origin develop
          
          # Backend
          echo "🔨 Building backend..."
          cd backend
          npm ci
          npm run build
          
          # Restart backend
          echo "🔄 Restarting backend..."
          pm2 restart utassets-api-dev
          
          # Frontend
          echo "🎨 Building frontend..."
          cd ../frontend
          npm ci
          npm run build
          
          # Copy to web directory
          echo "📦 Copying files to /var/www..."
          sudo rm -rf /var/www/utassets-dev/*
          sudo cp -r build/* /var/www/utassets-dev/
          
          echo "✅ DEV deployment completed!"
          echo "🌐 https://dev.utassets.umtelkomd.net"