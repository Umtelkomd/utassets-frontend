#!/bin/sh

# Hook de pre-commit para UTAssets Frontend
# Guardar este archivo como .git/hooks/pre-commit y hacer ejecutable (chmod +x .git/hooks/pre-commit)

echo "Ejecutando verificaciones de pre-commit..."

# 1. Verificar si hay console.log en archivos a commitear (excepto en archivos especÃ­ficos)
files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' | grep -v "axiosConfig\|reportWebVitals\|ErrorBoundary")

if [ -n "$files" ]; then
  # Buscar console.log en archivos staged
  console_logs=$(grep -l "console.log" $files | grep -v "axiosConfig\|reportWebVitals\|ErrorBoundary")
  
  if [ -n "$console_logs" ]; then
    echo "âŒ Error: Se encontraron console.log en los siguientes archivos:"
    echo "$console_logs"
    echo ""
    echo "Por favor, elimina todos los console.log antes de hacer commit,"
    echo "o usa --no-verify para bypasear esta verificaciÃ³n (no recomendado)."
    exit 1
  fi
fi

# 2. Verificar si hay archivos sensibles
sensitive_files=$(git diff --cached --name-only | grep -E '(\.env|\.key|password|secret|credential)')

if [ -n "$sensitive_files" ]; then
  echo "âš ï¸ Advertencia: EstÃ¡s intentando commitear archivos que podrÃ­an contener informaciÃ³n sensible:"
  echo "$sensitive_files"
  echo ""
  echo "Â¿EstÃ¡s seguro de que quieres commitear estos archivos? (s/N)"
  read -r response
  
  if [ "$response" != "s" ] && [ "$response" != "S" ]; then
    echo "Commit abortado."
    exit 1
  fi
fi

# 3. Ejecutar ESLint en archivos staged
if command -v npx >/dev/null 2>&1; then
  if [ -n "$files" ]; then
    echo "ğŸ” Ejecutando ESLint en archivos staged..."
    npx eslint $files
    
    if [ $? -ne 0 ]; then
      echo "âŒ Error: ESLint encontrÃ³ errores crÃ­ticos. Por favor, arregla los errores antes de hacer commit."
      echo "â„¹ï¸  Los warnings estÃ¡n permitidos y no bloquean el commit."
      exit 1
    fi
  fi
else
  echo "âš ï¸ npx no estÃ¡ disponible, saltando verificaciÃ³n de ESLint."
fi

# 4. Ejecutar Prettier en archivos staged
if command -v npx >/dev/null 2>&1; then
  if [ -n "$files" ]; then
    echo "ğŸ’… Formateando cÃ³digo con Prettier..."
    npx prettier --write $files
    git add $files
  fi
else
  echo "âš ï¸ npx no estÃ¡ disponible, saltando formateo con Prettier."
fi

echo "âœ… Todas las verificaciones pasaron! Procediendo con el commit..."
exit 0 